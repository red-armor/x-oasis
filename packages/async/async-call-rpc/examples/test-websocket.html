<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Client Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .status.connecting {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
        }
        .status.connected {
            background-color: #d4edda;
            border: 1px solid #28a745;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
        }
        code {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .console-hint {
            background-color: #e7f3ff;
            padding: 15px;
            border-left: 4px solid #2196F3;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Œ WebSocket RPC å®¢æˆ·ç«¯æµ‹è¯•</h1>

    <div id="status" class="status connecting">
        <strong>çŠ¶æ€:</strong> æ­£åœ¨è¿æ¥ WebSocket æœåŠ¡å™¨...
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ å¯ç”¨çš„æœåŠ¡å™¨æ–¹æ³•</h3>
        <ul>
            <li><code>server.echo(x)</code> - å›æ˜¾ä¼ å…¥çš„å‚æ•°</li>
            <li><code>server.now()</code> - è¿”å›å½“å‰æ—¶é—´æˆ³</li>
            <li><code>server.add(a, b)</code> - è®¡ç®—ä¸¤ä¸ªæ•°å­—çš„å’Œ</li>
        </ul>
    </div>

    <div class="console-hint">
        <h3>ğŸ’¡ åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æµ‹è¯•</h3>
        <p>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)ï¼Œåœ¨æ§åˆ¶å°ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p>
        <pre><code>// æµ‹è¯• echo æ–¹æ³•
await server.echo("Hello!")

// æµ‹è¯• now æ–¹æ³•
await server.now()

// æµ‹è¯• add æ–¹æ³•
await server.add(10, 20)

// æµ‹è¯•å¤æ‚å¯¹è±¡
await server.echo({name: "test", value: 42})</code></pre>
        <p><strong>æç¤º:</strong> ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>window.remote</code> ä»£æ›¿ <code>server</code></p>
    </div>

    <div class="test-section">
        <h3>ğŸ“ æ£€æŸ¥æ¸…å•</h3>
        <ul>
            <li>âœ… ç¡®ä¿ WebSocket æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (<code>node node.websocket.server.js</code>)</li>
            <li>âœ… æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è‡ªåŠ¨æµ‹è¯•ç»“æœ</li>
            <li>âœ… åœ¨æ§åˆ¶å°ä¸­æ‰‹åŠ¨æµ‹è¯• RPC è°ƒç”¨</li>
            <li>âœ… æ£€æŸ¥ç½‘ç»œæ ‡ç­¾é¡µä¸­çš„ WebSocket è¿æ¥çŠ¶æ€</li>
        </ul>
    </div>

    <script type="module" src="./browser.websocket.client.js"></script>
    <script>
        // ç›‘å¬è¿æ¥çŠ¶æ€
        let statusEl = document.getElementById('status')
        let connectionEstablished = false

        // ç›‘å¬ WebSocket è¿æ¥çŠ¶æ€
        window.addEventListener('websocket-open', () => {
            connectionEstablished = true
        })

        window.addEventListener('websocket-error', () => {
            if (!connectionEstablished) {
                statusEl.className = 'status error'
                statusEl.innerHTML = '<strong>çŠ¶æ€:</strong> âŒ è¿æ¥å¤±è´¥<br>' +
                    'è¯·ç¡®ä¿:<br>' +
                    '1. æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: <code>node node.websocket.server.js</code><br>' +
                    '2. æœåŠ¡å™¨ç›‘å¬åœ¨ ws://localhost:3456<br>' +
                    '3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯'
            }
        })

        // æ£€æŸ¥ server å¯¹è±¡æ˜¯å¦å¯ç”¨
        const checkServer = setInterval(() => {
            if (window.server && typeof window.server.echo === 'function') {
                clearInterval(checkServer)
                connectionEstablished = true
                statusEl.className = 'status connected'
                statusEl.innerHTML = '<strong>çŠ¶æ€:</strong> âœ… å·²è¿æ¥åˆ° WebSocket æœåŠ¡å™¨ (ws://localhost:3456)'
            }
        }, 100)

        // 10ç§’åå¦‚æœè¿˜æ²¡è¿æ¥ï¼Œæ˜¾ç¤ºé”™è¯¯
        setTimeout(() => {
            if (!connectionEstablished && statusEl.className === 'status connecting') {
                statusEl.className = 'status error'
                statusEl.innerHTML = '<strong>çŠ¶æ€:</strong> âŒ è¿æ¥è¶…æ—¶<br>' +
                    'è¯·ç¡®ä¿:<br>' +
                    '1. æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: <code>node node.websocket.server.js</code><br>' +
                    '2. æœåŠ¡å™¨ç›‘å¬åœ¨ ws://localhost:3456<br>' +
                    '3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯'
            }
        }, 10000)
    </script>
</body>
</html>
